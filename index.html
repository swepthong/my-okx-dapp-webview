<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <title>OKX + Solana (WebView) Demo</title>
    <style>
        body { font-family: system-ui, -apple-system, Roboto, Arial; padding:16px; }
        pre { background:#f6f8fa; padding:12px; border-radius:8px; overflow:auto; }
        .muted { color:#666 }
    </style>
</head>
<body>
<h2>OKX Connect (Solana) – WebView Demo</h2>
<pre id="log"></pre>

              <!-- OKX UI (主要包) -->
       <script src="https://cdn.jsdelivr.net/npm/@okxconnect/ui@1.8.8/dist/okxconnect_ui.min.js"></script>
       <!-- OKX Solana Provider (专门为 Solana 优化) -->
       <script src="https://cdn.jsdelivr.net/npm/@okxconnect/solana-provider@1.8.8/dist/okxconnect_solana.min.js"></script>
       <!-- 可选：bs58（用于消息签名优先走 base58 编码） -->
       <script src="https://cdn.jsdelivr.net/npm/bs58@5.0.0/index.js"></script>

<script>
    const logEl = document.getElementById('log');
    const AndroidBridge = window.AndroidBridge || {
      onConnected: (...a)=>console.log("[onConnected]",...a),
      onSigned:    (...a)=>console.log("[onSigned]",...a),
      onError:     (...a)=>console.error("[onError]",...a),
      onReady:     (...a)=>console.log("[onReady]",...a),
    };

    function log(...args) {
      const line = args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' ');
      logEl.textContent += line + '\n';
    }

    // Polyfill
    if (typeof window.TextEncoder === 'undefined') {
      window.TextEncoder = function () {
        return { encode: s => new Uint8Array(unescape(encodeURIComponent(s)).split('').map(c => c.charCodeAt(0))) }
      };
    }

    // 配置
    const dappMeta = {
      name: "AIDR",
      icon: "https://aidr.plus/icon.png"  // 使用你的实际域名
    };
    const redirect = "solpocket://wallet-callback";
    const CHAINS = ["solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp"]; // solana mainnet - 使用官方文档的正确格式

        let universalUi, okxSolanaProvider, session, solAddress;

    async function ensureProvider() {
      if (universalUi) return universalUi;
      
      // 添加调试代码 - 检查 UI 包
      console.log('Script loading check:');
      console.log('window.OKXUniversalConnectUI:', window.OKXUniversalConnectUI);
      console.log('All window properties:', Object.keys(window).filter(key => key.includes('OKX')));
      
      // 检查 UI 包
      if (window.OKXUniversalConnectUI) {
        console.log('OKXUniversalConnectUI type:', typeof window.OKXUniversalConnectUI);
        console.log('OKXUniversalConnectUI properties:', Object.getOwnPropertyNames(window.OKXUniversalConnectUI));
        console.log('OKXUniversalConnectUI has init method:', typeof window.OKXUniversalConnectUI.init === 'function');
      }
      
      // 使用 UI 包初始化
      if (!window.OKXUniversalConnectUI) throw new Error("OKX UI 包未加载完成");
      
      universalUi = await window.OKXUniversalConnectUI.init({
        dappMetaData: {
          icon: dappMeta.icon,
          name: dappMeta.name
        },
        actionsConfiguration: {
          returnStrategy: redirect,
          modals: 'all'
        },
        language: 'zh_CN'
      });
      
      console.log('UI initialized:', universalUi);
      console.log('UI methods:', Object.getOwnPropertyNames(universalUi));
      
      // 创建 Solana Provider
      if (window.OKXSolanaProvider) {
        okxSolanaProvider = new window.OKXSolanaProvider(universalUi);
        console.log('Solana Provider created:', okxSolanaProvider);
      }
      
      AndroidBridge.onReady();
      return universalUi;
    }

    // ---- 全局方法（原生可直接调用） ----
    window.connectWallet = async function() {
      try {
        console.log('Starting OKX connection...');
        await ensureProvider();
        console.log('UI ready, attempting to connect...');
        
        // 按照官方文档的格式，使用 openModal 方法
        const connectParams = {
          namespaces: {
            solana: {
              chains: ["solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp"] // 使用官方文档的确切格式
            }
          }
        };
        
        console.log('Connect params:', connectParams);
        
        try {
          // 使用 openModal 方法连接钱包
          session = await universalUi.openModal(connectParams);
          console.log('Connection successful:', session);
          
          if (session && session.namespaces && session.namespaces.solana && session.namespaces.solana.accounts) {
            const acc = session.namespaces.solana.accounts[0];
            solAddress = acc?.split(':').pop();
            console.log('Solana address:', solAddress);
          }
        } catch (e) {
          console.log('Connection failed:', e.message);
          throw e;
        }
        
        console.log('Connection session:', session);
        console.log('Session namespaces:', session?.namespaces);
        console.log('Solana accounts:', session?.namespaces?.solana?.accounts);
        
        const acc = session?.namespaces?.solana?.accounts?.[0];
        solAddress = acc?.split(':').pop();
        log("Connected:", solAddress);
        AndroidBridge.onConnected(JSON.stringify({ address: solAddress }));
        return solAddress;
      } catch(e) {
        console.error('Connection error details:', e);
        console.error('Error stack:', e.stack);
        log("connect error:", e.message);
        AndroidBridge.onError(e.message);
        throw e;
      }
    };

    window.signMessage = async function(msg="Hello from AIDR") {
      try {
        if (!okxSolanaProvider || !solAddress) throw new Error("Not connected");
        
        // 使用 Solana Provider 的 signMessage 方法
        const result = await okxSolanaProvider.signMessage(msg, "solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp");
        
        log("signMessage result:", result);
        AndroidBridge.onSigned(JSON.stringify(result));
        return result;
      } catch(e) {
        AndroidBridge.onError(e.message);
        throw e;
      }
    };

    window.signTransaction = async function(txBase64) {
      try {
        if (!up || !solAddress) throw new Error("Not connected");
        const res = await up.request({
          namespace:"solana", method:"solana_signTransaction",
          params:{ address: solAddress, transaction: txBase64 }
        });
        AndroidBridge.onSigned(JSON.stringify(res));
        return res;
      } catch(e) {
        AndroidBridge.onError(e.message);
        throw e;
      }
    };

            window.signAndSendTransaction = async function(txBase64) {
          try {
            if (!up || !solAddress) throw new Error("Not connected");
            const res = await up.request({
              namespace:"solana", method:"solana_signAndSendTransaction",
              params:{ address: solAddress, transaction: txBase64 }
            });
            AndroidBridge.onSigned(JSON.stringify(res));
            return res;
          } catch(e) {
            AndroidBridge.onError(e.message);
            throw e;
          }
        };
        
        // 页面加载完成
        window.addEventListener('load', function() {
            console.log('AIDR Wallet Connect page loaded');
            console.log('AndroidBridge available:', !!window.AndroidBridge);
            
            // 监听页面可见性变化
            document.addEventListener('visibilitychange', function() {
                console.log('Page visibility changed:', document.hidden);
                console.log('Current URL:', window.location.href);
                console.log('Document title:', document.title);
            });
            
            // 监听页面焦点变化
            window.addEventListener('focus', function() {
                console.log('Window focused');
            });
            
            window.addEventListener('blur', function() {
                console.log('Window blurred');
            });
        });
</script>
</body>
</html>
